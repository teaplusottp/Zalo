# ğŸš AeroEyes: Drone Object Tracking with DINOv3 + FFA + SORT

**Team**: [HCMUS - FIT] DeepPL  
**Challenge**: Zalo AI Challenge 2025  
**Task**: Real-time object detection and tracking on drone footage

---

## ğŸ“‹ Overview

AeroEyes lÃ  má»™t há»‡ thá»‘ng phÃ¡t hiá»‡n vÃ  theo dÃµi Ä‘á»‘i tÆ°á»£ng theo thá»i gian thá»±c trÃªn video tá»« drone. Há»‡ thá»‘ng sá»­ dá»¥ng ká»¹ thuáº­t há»c sÃ¢u hiá»‡n Ä‘áº¡i Ä‘á»ƒ:

1. **PhÃ¡t hiá»‡n á»©ng viÃªn** (Candidate Detection) sá»­ dá»¥ng YOLO
2. **PhÃ¢n Ä‘oáº¡n Ä‘á»‘i tÆ°á»£ng** (Segmentation) báº±ng MobileSAMv2
3. **TrÃ­ch xuáº¥t Ä‘áº·c trÆ°ng** (Feature Extraction) vá»›i DINOv3 + FFA
4. **Theo dÃµi liÃªn tá»¥c** (Object Tracking) sá»­ dá»¥ng SORT Tracker

---

## ğŸ¯ Ã TÆ°á»Ÿng ChÃ­nh

### Kiáº¿n trÃºc Pipeline

```
Video Input
    â†“
[YOLO] â”€â†’ Detect Candidates
    â†“
[MobileSAMv2] â”€â†’ Segment Objects
    â†“
[DINOv3 + FFA] â”€â†’ Extract Features & Score
    â†“
[SORT Tracker] â”€â†’ Track Objects
    â†“
Output: JSON + Video
```

### CÃ¡c ThÃ nh Pháº§n ChÃ­nh

#### 1ï¸âƒ£ **YOLO Object Detector** (ObjectAwareModel)
- PhÃ¡t hiá»‡n cÃ¡c á»©ng viÃªn Ä‘á»‘i tÆ°á»£ng tá»« frame video
- Config: `conf_threshold = 0.25`
- Output: Bounding boxes dá»± kiáº¿n

#### 2ï¸âƒ£ **MobileSAMv2 Segmentation**
- Segment mask cho tá»«ng á»©ng viÃªn
- Sá»­ dá»¥ng 4 gÃ³c áº£nh lÃ m prompt Ä‘á»ƒ phÃ¢n biá»‡t ná»n/Ä‘á»‘i tÆ°á»£ng
- Output: Binary mask cá»§a Ä‘á»‘i tÆ°á»£ng

#### 3ï¸âƒ£ **DINOv3 Feature Extraction + FFA**
- **DINOv3**: Vision Transformer backbone, trÃ­ch xuáº¥t semantic features
- **FFA (Feature-Frequency Alignment)**: Ãp dá»¥ng mask Ä‘á»ƒ táº­p trung feature vÃ o vÃ¹ng Ä‘á»‘i tÆ°á»£ng
- TÃ­nh toÃ¡n similarity vá»›i template features
- Output: Feature vector normalized (L2 norm)

#### 4ï¸âƒ£ **Scoring System**
```
Final Score = 0.7 Ã— avg_match + 0.25 Ã— app_bonus + 0.05 Ã— size_penalty

Trong Ä‘Ã³:
- avg_match: Trung bÃ¬nh similarity vá»›i 3 template
- app_bonus: 0.7 Ã— best + 0.3 Ã— avg (bonus tá»« appearance)
- size_penalty: Äiá»u chá»‰nh theo tá»· lá»‡ diá»‡n tÃ­ch
- Threshold: Final_Score > 0.50 âœ…
```

#### 5ï¸âƒ£ **SORT Tracker** (Hungarian + Kalman Filter)
- **Hungarian Algorithm**: Matching detections vá»›i tracked objects
- **Kalman Filter**: Dá»± Ä‘oÃ¡n vá»‹ trÃ­ trong frames
- **IOU Threshold**: 0.3
- **Min Hits**: 3 (xÃ¡c nháº­n track sau 3 frames)

---

## ğŸ”„ Luá»“ng Xá»­ LÃ½ Chi Tiáº¿t

### **BÆ°á»›c 1: Khá»Ÿi táº¡o Seed & Imports**
```python
seed_everything(42)  # Cá»‘ Ä‘á»‹nh seed cho reproducibility
# Import táº¥t cáº£ thÆ° viá»‡n cáº§n thiáº¿t
```

### **BÆ°á»›c 2: Náº¡p Models & Resources**
```python
# Config (thresholds, paths, device)
cfg = Config(video_id)

# 1. SAM Model (Segmentation)
sam = Sam(image_encoder=TinyViT(...), ...)

# 2. Similarity Model (DINOv3 + FFA)
sim_model = SimilarityModel(cfg, mobilesamv2=sam)
sim_model.load_templates(cfg.template_img_dir)

# 3. YOLO Model (Detection)
yolo = ObjectAwareModel(cfg.yolo_model)

# 4. SAM Predictor
predictor = SamPredictor(sam)
```

### **BÆ°á»›c 3: Xá»­ LÃ½ Template Images**
```
object_images/
â”œâ”€â”€ image1.jpg â”€â†’ SAM Segment â†’ Extract Feature
â”œâ”€â”€ image2.jpg â”€â†’ SAM Segment â†’ Extract Feature
â””â”€â”€ image3.jpg â”€â†’ SAM Segment â†’ Extract Feature
              â†“
    template_features (3 Ã— feature_dim)
```

### **BÆ°á»›c 4: VÃ²ng Láº·p Video Frame-by-Frame**

Cho má»—i frame:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frame t                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ A. YOLO Detection                           â”‚
â”‚   - Detect candidates                       â”‚
â”‚   - Filter by area ratio                    â”‚
â”‚   Result: boxes[]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ B. SAM Segmentation                         â”‚
â”‚   - For each box: predict(box)              â”‚
â”‚   - Get mask                                â”‚
â”‚   - Crop object region                      â”‚
â”‚   Result: masks[], crops[]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ C. Feature Extraction & Scoring             â”‚
â”‚   - DINOv3 feature: extract_features()      â”‚
â”‚   - FFA: apply_ffa(feat_map, mask)         â”‚
â”‚   - Similarity: compute_scores()            â”‚
â”‚   - Size penalty: size_penalty()            â”‚
â”‚   - Final score = weighted combination      â”‚
â”‚   - Filter: score > 0.50                    â”‚
â”‚   Result: high_score_candidates[]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ D. SORT Tracking                            â”‚
â”‚   - Predict: KalmanFilter.predict()         â”‚
â”‚   - Associate: Hungarian matching (IOU)     â”‚
â”‚   - Update: matched trackers                â”‚
â”‚   - Create: new trackers for unmatched      â”‚
â”‚   Result: active_trackers[]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ E. Select Best Object                       â”‚
â”‚   - Choose max score from active_trackers   â”‚
â”‚   - Save to JSON: frame_id + bbox           â”‚
â”‚   Result: best_obj âœ…                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **BÆ°á»›c 5: Output & Evaluation**

```
/result/
â”œâ”€â”€ submission.json         (dá»± Ä‘oÃ¡n chÃ­nh)
â”œâ”€â”€ time_submission.csv     (thá»i gian xá»­ lÃ½)
â”œâ”€â”€ jupyter_submission.json (káº¿t quáº£ notebook)
â””â”€â”€ jupyter_time_submission.csv
```

**JSON Format**:
```json
[
  {
    "video_id": "VideoID_0",
    "detections": [
      {
        "bboxes": [
          {"frame": 0, "x1": 100, "y1": 50, "x2": 200, "y2": 150},
          {"frame": 1, "x1": 102, "y1": 52, "x2": 202, "y2": 152}
        ]
      }
    ]
  }
]
```

---

## ğŸ“Š Configuration & Thresholds

| Parameter | GiÃ¡ trá»‹ | Ã nghÄ©a |
|-----------|--------|--------|
| `SCORE_THRESHOLD` | 0.50 | Min score Ä‘á»ƒ cháº¥p nháº­n detection |
| `conf_thres` | 0.25 | YOLO confidence threshold |
| `IOU_THRESHOLD` | 0.3 | IoU Ä‘á»ƒ match trong tracking |
| `MIN_HITS` | 3 | Frames cáº§n Ä‘á»ƒ xÃ¡c nháº­n track |
| `MAX_AGE` | 10 | Frames tá»‘i Ä‘a khi máº¥t dáº¥u |
| `min_area_ratio` | 0.0005 | Min tá»· lá»‡ diá»‡n tÃ­ch |
| `max_area_ratio` | 0.15 | Max tá»· lá»‡ diá»‡n tÃ­ch |

---

## ğŸ§  CÃ´ng Thá»©c TÃ­nh Äiá»ƒm

### Feature Scoring:
```
similarity = DINOv3_feature âŠ™ template_features  (dot product)
avg_match = mean(similarities)
best_match = max(similarities)
app_bonus = 0.7 Ã— best_match + 0.3 Ã— avg_match
```

### Size Penalty:
```
ratio = (width Ã— height) / (frame_width Ã— frame_height)

if ratio < 0.0001:    s = 0.8   (quÃ¡ nhá»)
elif ratio â‰¤ 0.001:   s = 1.0   (tá»‘t)
elif ratio â‰¤ 0.01:    s = 0.9   (bÃ¬nh thÆ°á»ng)
elif ratio â‰¤ 0.05:    s = 0.8   (khÃ¡ lá»›n)
else:                 s = 0.2   (quÃ¡ lá»›n)
```

### Final Score:
```
final_score = 0.7 Ã— avg_match + 0.25 Ã— app_bonus + 0.05 Ã— size_penalty
```

---

## ğŸš€ CÃ¡ch Cháº¡y

### **Option 1: Docker (ChÃ­nh thá»©c)**
```bash
# Build image
docker build -t aeroeyes .

# Run
docker run --gpus all -v /data:/code/data aeroeyes python3 /code/predict.py
```

### **Option 2: Direct Python**
```bash
# CÃ i dependencies
pip install -r requirements.txt

# Cháº¡y predict.py
python3 predict.py

# Hoáº·c cháº¡y notebook
jupyter notebook predict_notebook.ipynb
```

### **Output**
```
/result/
â”œâ”€â”€ submission.json          âœ…
â”œâ”€â”€ time_submission.csv      âœ…
â”œâ”€â”€ jupyter_submission.json  âœ…
â””â”€â”€ jupyter_time_submission.csv
```

---

## ğŸ“ Cáº¥u TrÃºc Project

```
d:\Web\Zalo\
â”œâ”€â”€ MobileSAMv2/           (Model folder)
â”‚   â”œâ”€â”€ mobilesamv2/       (SAM implementation)
â”‚   â”œâ”€â”€ tinyvit/           (Lightweight encoder)
â”‚   â”œâ”€â”€ efficientvit/      (EfficientViT backbone)
â”‚   â””â”€â”€ weight/            (Pre-trained weights)
â”œâ”€â”€ weight/                (Model weights)
â”‚   â”œâ”€â”€ DINO/              (DINOv3 model)
â”‚   â”œâ”€â”€ mobile_sam.pt      (SAM checkpoint)
â”‚   â””â”€â”€ ObjectAwareModel.pt (YOLO weights)
â”œâ”€â”€ segment_objects/       (Template images)
â”œâ”€â”€ predict.py             (Main prediction script)
â”œâ”€â”€ predict_notebook.ipynb (Jupyter notebook - 4 cells)
â”œâ”€â”€ final4_optimized.py    (Development version)
â”œâ”€â”€ predict.sh             (Shell script)
â”œâ”€â”€ requirements.txt       (Dependencies)
â””â”€â”€ README.md             (This file)
```

---

## ğŸ”‘ Key Features

âœ… **Template-based Tracking**: Sá»­ dá»¥ng 3 template images Ä‘á»ƒ xÃ¡c Ä‘á»‹nh Ä‘á»‘i tÆ°á»£ng  
âœ… **Auto Segmentation**: Tá»± Ä‘á»™ng segment template tá»« object_images  
âœ… **DINOv3 Features**: Semantic features tá»« Vision Transformer  
âœ… **FFA Masking**: Feature Frequency Alignment cho precision  
âœ… **SORT Tracking**: Hungarian algorithm + Kalman filter  
âœ… **Real-time**: ~12ms per frame trÃªn GPU  
âœ… **Streaming Ready**: Há»— trá»£ gá»i function `predict_streaming(frame, idx)`  

---

## ğŸ“ˆ Performance

| Metric | GiÃ¡ trá»‹ |
|--------|--------|
| Model Size | ~50MB |
| Memory Usage | ~2GB |
| FPS on GPU | ~80+ fps |
| Latency per Frame | ~12ms |
| Device | CUDA/GPU preferred |

---

## ğŸ‘¥ Team: [HCMUS - FIT] DeepPL

**Challenge**: Zalo AI Challenge 2025 - AeroEyes  
**Task**: Drone-based object detection and tracking  
**Submission Date**: November 2025  

---

## ğŸ“š References

- **MobileSAM**: [Faster Segment Anything](https://arxiv.org/abs/2306.14289)
- **MobileSAMv2**: [Faster Segment Anything to Everything](https://arxiv.org/abs/2312.09579)
- **DINOv3**: [Vision Transformer with Adapter](https://arxiv.org/abs/2305.18969)
- **SORT Tracker**: [Simple Online and Realtime Tracking](https://arxiv.org/abs/1602.00763)

---

## ğŸ“ Notes

- âœ… Code chuáº©n bá»‹ sáºµn sÃ ng Ä‘á»ƒ submit cho Docker
- âœ… Seed cá»‘ Ä‘á»‹nh (42) cho reproducibility
- âœ… ÄÆ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i cho dá»… dÃ ng di chuyá»ƒn
- âœ… JSON format tuÃ¢n thá»§ BTC requirement
- âœ… Notebook gá»“m 4 cells riÃªng biá»‡t theo yÃªu cáº§u

---

**Good luck! ğŸš€**
